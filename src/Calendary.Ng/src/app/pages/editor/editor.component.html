<section class="editor-page">
  <div class="loading" *ngIf="isLoading">
    <mat-progress-spinner color="primary" mode="indeterminate"></mat-progress-spinner>
    <p>Завантаження редактора...</p>
  </div>

  <div class="editor-content" *ngIf="!isLoading">
    <nav class="breadcrumbs">
      <a routerLink="/">Головна</a>
      <mat-icon>chevron_right</mat-icon>
      <span>Редактор</span>
    </nav>

    <div class="editor-layout">
      <!-- Left Sidebar: Tools and Actions -->
      <aside class="editor-left-sidebar">
        <app-sidebar
          (generateImage)="openGenerateModal()"
          (uploadImage)="uploadImage()"
          (saveImage)="onImageSaved(null!)"
          (exportImage)="onExportImage()"
        ></app-sidebar>

        <div class="history-panel">
          <app-history></app-history>
        </div>
      </aside>

      <!-- Main Content Area -->
      <section class="editor-main">
        <header class="editor-header">
          <div>
            <p class="tagline">AI редактор зображень</p>
            <h1>Полотно</h1>
          </div>
        </header>

        <div class="canvas-wrapper" *ngIf="activeModel; else noModel">
          <app-image-canvas
            [selectedImage]="selectedImage"
            (imageSaved)="onImageSaved($event)"
          ></app-image-canvas>
        </div>
        <ng-template #noModel>
          <div class="canvas-empty">
            <mat-icon>info</mat-icon>
            <p>Оберіть модель або створіть нову у розділі «Майстер».</p>
          </div>
        </ng-template>

        <!-- Bottom Toolbar -->
        <div class="toolbar-section">
          <app-toolbar></app-toolbar>
        </div>
      </section>

      <!-- Right Sidebar: Models, Gallery and Properties -->
      <aside class="editor-right-sidebar">
        <div class="sidebar-panel models-panel">
          <h3>Мої моделі</h3>
          <p *ngIf="loadError" class="error">{{ loadError }}</p>
          <ul class="models-list" *ngIf="userModels.length; else emptyModels">
            <li
              *ngFor="let model of userModels"
              (click)="selectModel(model)"
              [class.active]="model === activeModel"
              [class.is-active-model]="model.isActive"
            >
              <div class="model-header">
                <div class="model-name">{{ model.name || ('FluxModel #' + model.id) }}</div>
                <mat-icon *ngIf="model.isActive" class="active-indicator" matTooltip="Активна модель">check_circle</mat-icon>
              </div>
              <div class="model-status">
                <mat-icon>fiber_manual_record</mat-icon>
                {{ model.status || 'unknown' }}
              </div>
            </li>
          </ul>
          <ng-template #emptyModels>
            <p class="muted">Створи Flux модель у майстрі, щоб розпочати.</p>
          </ng-template>
        </div>

        <div class="sidebar-panel gallery-panel" *ngIf="activeModel">
          <app-image-gallery
            [jobs]="activeModel.jobs || []"
            [assignments]="assignments"
            (imageSelected)="onImageSelected($event)"
            (imageDeleted)="onImageDeleted($event)"
            (addToCalendar)="onAddToCalendar($event)"
          ></app-image-gallery>
        </div>

        <div class="sidebar-panel properties-panel">
          <app-properties-panel
            [selectedImage]="selectedImage"
          ></app-properties-panel>
        </div>

        <app-calendar-preview
          *ngIf="activeModel"
          class="calendar-panel"
          [assignments]="assignments"
          [duplicateImageIds]="duplicateImageIds"
          (monthSelected)="onMonthSlotSelected($event)"
          (clearMonth)="onMonthAssignmentCleared($event)"
          (clearAll)="onClearAllAssignments()"
          (swapRequested)="onMonthSwap($event)"
        ></app-calendar-preview>
      </aside>
    </div>
  </div>
</section>
